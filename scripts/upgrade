#!/bin/bash

ynh_setting() {
  app=${1}
  setting=${2}

  sudo grep "^${setting}:" "/etc/yunohost/apps/${app}/settings.yml" | sed s/^[^:]\\+:\\s*[\"\']\\?// | sed s/\\s*[\"\']\$//
}

source ./prerequisites

cachedir=/var/cache/labriqueinternet/
domain=$(ynh_setting vpnclient domain)
path=$(ynh_setting vpnclient path)
server_name=$(ynh_setting vpnclient server_name)

sudo mkdir -m 0700 -p "${cachedir}/vpnclient/"
backupdir=$(mktemp -dp ${cachedir}/vpnclient/ upgrade_$(date +%Y-%m-%d-%H%M%S)_XXXXX)

sudo tar czf "${backupdir}/etc_openvpn.tgz" /etc/openvpn/
sudo cp -a /etc/yunohost/apps/vpnclient/settings.yml "${backupdir}/"
sudo cp -a /etc/openvpn/keys/ "${backupdir}/"

if [ ! -e /etc/openvpn/client.conf.tpl.restore ] || ! cmp -s /etc/openvpn/client.conf.tpl{,.restore}; then
  sudo cp -a /etc/openvpn/client.conf.tpl "${backupdir}/"
fi

export VPNCLIENT_UPGRADE=1
sudo bash /etc/yunohost/apps/vpnclient/scripts/remove &> /dev/null
bash ./install "${domain}" "${path}" "${server_name}"

sudo cp -a "${backupdir}/settings.yml" /etc/yunohost/apps/vpnclient/
sudo cp -a "${backupdir}/keys/"* /etc/openvpn/keys/ 2> /dev/null
sudo cp -a "${backupdir}/client.conf.tpl" /etc/openvpn/ 2> /dev/null

# Changes

if [ -z "$(ynh_setting vpnclient dns0)" ]; then
  sudo yunohost app setting vpnclient dns0 -v 89.234.141.66
  sudo yunohost app setting vpnclient dns1 -v 2001:913::8
fi

sudo systemctl start ynh-vpnclient

exit 0
